name: Create Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.0.1, 1.1.0, 2.0.0)'
        required: true
        type: string
      release_type:
        description: 'Release type'
        required: true
        type: choice
        options:
          - patch  # ë²„ê·¸ ìˆ˜ì • (1.0.0 â†’ 1.0.1)
          - minor  # ìƒˆ ê¸°ëŠ¥ (1.0.0 â†’ 1.1.0)
          - major  # í˜¸í™˜ì„± ë³€ê²½ (1.0.0 â†’ 2.0.0)
        default: 'patch'

permissions:
  contents: write

jobs:
  create-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Get version
        id: version
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
          else
            # ìžë™ìœ¼ë¡œ ë²„ì „ ê³„ì‚°
            LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
            VERSION="${LATEST_TAG#v}"

            IFS='.' read -r -a VERSION_PARTS <<< "$VERSION"
            MAJOR="${VERSION_PARTS[0]}"
            MINOR="${VERSION_PARTS[1]}"
            PATCH="${VERSION_PARTS[2]}"

            case "${{ inputs.release_type }}" in
              major)
                MAJOR=$((MAJOR + 1))
                MINOR=0
                PATCH=0
                ;;
              minor)
                MINOR=$((MINOR + 1))
                PATCH=0
                ;;
              patch)
                PATCH=$((PATCH + 1))
                ;;
            esac

            VERSION="${MAJOR}.${MINOR}.${PATCH}"
          fi

          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag=v${VERSION}" >> $GITHUB_OUTPUT

      - name: Generate release notes
        id: release_notes
        run: |
          # ì´ì „ íƒœê·¸ë¶€í„° í˜„ìž¬ê¹Œì§€ì˜ ì»¤ë°‹ ë¡œê·¸ ìƒì„±
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || git rev-list --max-parents=0 HEAD)

          echo "## ðŸ“ ë³€ê²½ì‚¬í•­" > release_notes.md
          echo "" >> release_notes.md

          # Conventional Commits í˜•ì‹ìœ¼ë¡œ ë¶„ë¥˜
          echo "### âœ¨ ìƒˆë¡œìš´ ê¸°ëŠ¥" >> release_notes.md
          git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s" --grep="^feat" >> release_notes.md || true
          echo "" >> release_notes.md
          echo "" >> release_notes.md

          echo "### ðŸ› ë²„ê·¸ ìˆ˜ì •" >> release_notes.md
          git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s" --grep="^fix" >> release_notes.md || true
          echo "" >> release_notes.md
          echo "" >> release_notes.md

          echo "### ðŸ”§ ê°œì„ ì‚¬í•­" >> release_notes.md
          git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s" --grep="^chore\|^refactor\|^perf" >> release_notes.md || true
          echo "" >> release_notes.md
          echo "" >> release_notes.md

          echo "### ðŸ“š ë¬¸ì„œ" >> release_notes.md
          git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s" --grep="^docs" >> release_notes.md || true
          echo "" >> release_notes.md
          echo "" >> release_notes.md

          echo "### ê¸°íƒ€ ë³€ê²½ì‚¬í•­" >> release_notes.md
          git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s" --grep="^build\|^ci\|^style\|^test" >> release_notes.md || true
          echo "" >> release_notes.md

          # ë¹ˆ ì„¹ì…˜ ì œê±°
          sed -i '/^### /N;/\n$/d' release_notes.md || true

          cat release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: "4sizn Blog ${{ steps.version.outputs.tag }} - ì—…ë°ì´íŠ¸"
          body_path: release_notes.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## ðŸŽ‰ ë¦´ë¦¬ì¦ˆ ìƒì„± ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ë²„ì „**: ${{ steps.version.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **íƒ€ìž…**: ${{ inputs.release_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ë¦´ë¦¬ì¦ˆ URL**: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ’¡ ë‹¤ìŒë‚  ì˜¤ì „ 9ì‹œì— ìžë™ìœ¼ë¡œ ë¸”ë¡œê·¸ì— ê²Œì‹œë©ë‹ˆë‹¤!" >> $GITHUB_STEP_SUMMARY
